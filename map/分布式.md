# 分布式

## 一、理论

### CAP

- C一致性
- A可用性
- P分区容错性：出故障后任然能提供正常服务

### BASE

- 基本可用
- 最终一致
  			读时修复
  			写时修复
  			异步对账
- 软状态

## 二、分布式事务

### XA

2PC

- 准备阶段 协调者询问参与者是否准备好
- 提交阶段 协调者commit 向参与者发送commit指令  超时 abort
- 缺点 commit阶段失败无法补救
- 缺点
  - 单点问题 需要协调者
  - 性能问题 交互复杂
  - 一致性风险 网络问题导致部分commit

3PC

- CanCommit：根据当前状态评估事务是否能完成 轻量级操作
- PreCommit：准备提交
- DoCommit：如果因为网络问题没有等到 DoCommit消息 默认提交
- 缺点
  - 单点问题
  - 性能问题：需要回滚时优于2PC
  - 一致性风险：增加

### AT

共享事务：共用同一个数据源

### saga

- 长事务拆分成短事务
- 每个端事务都需要有补偿机制

### tcc

- try：尝试节点 完成业务执行检查  预留资源 （占库存）
- confirm：确认执行 使用预占资源完成提交 处理幂等
- cancel：释放占用资源

问题：

- 空回滚
- 资源悬挂
- 幂等

## 三、算法

### 2PC

- 阶段一 协调者发起请求 参与者判断是否可执行
- 阶段二所有参与者执行并提交事务

### tcc

- try confirm cancel
- 不依赖数据库事务 对业务代码侵入强

### paxos

角色

- 提议者
- 接受者
- 学习者

步骤

- 提议者携带编号提议
- 接受者根据接收到的提案反馈
  				尚无提案：承诺不会接受小于编号的提案
  				已有提案：丢弃编号小的提案
- 提议者接收到大多数接受者响应
- 发起接受请求
- 接受者根据之前的承诺接受Or拒绝请求

BasePaxos只能就单个值达成共识

MultiPaxos

- 领导者：只有一个提议者，通过BasePaxos协议选举出来
- 一种思想：raft也是MultiPaxos

### zab

zookeeper实现

### raft

- 分布式系统开发首选共识算法
- 一切以领导者为准
  			值的共识
  			各节点日志一致
- 角色
  			领导者
  			跟随者
  			候选人
- 领导者选举过程

### gossip

- 直接邮寄
- 反熵
- 谣言传播

### quorum nwr

### pbft

### pow

## 四、LSM树

### Log-Structured Merged-Tree

### 基本思想

把所有的查、更新、删除保存在内存，达到一定阈值之后 批量写入磁盘 写入磁盘时进行合并

### 组成

- wal
- memtable
- ssttable

## 五、限流算法

- 计数器
  		有临界问题
- 滑动窗口
  		单位周期内划分多个格子
  		解决临界问题
- 漏斗算法
  		请求来时放入漏斗中 满则限流
  		漏斗以固定速率流出 处理
  		能够应对峰值
- 令牌桶
  		匀速放令牌到桶中 直到桶满
  		请求到达时 获取令牌 如果无法获取 限流
  		有buffer 能够应对峰值

## 六、分布式ID

- UUID
- 数据库自增ID
- 批量生成ID
- Redis ID
- snowflake
  		时间戳：41
  		机器ID：10
  		统一毫秒产生的ID：12
- 百度UidGenerator
- 美团leaf
  		https://tech.meituan.com/2017/04/21/mt-leaf.html
  		leaf-segment
  		leaf-snowflake
  			时钟回退解决方案
  				关闭NTP
  				启动快速失败

## 七、脑裂

选举阶段出现通信问题 造成出现两个leader，怎么防止脑裂？

## 八、一致性

- 强一致：保证写操作完成后，任何后续访问都能读到更新后的值。
- 弱一致：写操作完成后，系统不能保证后续的访问都能读到更新后的值。
- 最终一致：保证如果对某个对象没有新的写操作了，最终所有后续访问都能读到相同的最近更新的值。

## 九、拜占庭将军问题

- 少数服从多数
- 通讯延迟 丢失
- 信息篡改
